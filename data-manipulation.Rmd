---
layout: default
title: 2 - Data manipulation
nav_order: 3
parent: Workshop Activities
customjs: http://code.jquery.com/jquery-1.4.2.min.js
output: 
  md_document:
    variant: gfm        # GitHub-friendly markdown
    preserve_yaml: TRUE # keep Jekyll front-matter
---

```{r setup, include=FALSE}
# This code block is to the benefit of anyone working with the .Rmd file to edit the workshop material, rather than participating in the workshop. Hence, it should always be setup to include = FALSE, so it does not appear in the knitted .md file 

# Make echo = TRUE the default option
knitr::opts_chunk$set(echo = TRUE)

# Make sure the packages are installed before running this file. If they aren't, you can run these commented install.packages() commands in the console. DO NOT UNCOMMENT THESE IN THIS DOCUMENT.
#IGNORE --install.packages("readxl")--
#IGNORE --library(readxl)--
#In the console at the beginning of your session, enter: install.packages("tidyverse", dependencies = TRUE)
#Check that you have installed knitr, tidyverse, dplyr and readxl by entering the `find.package("package_name")` in the console at the beginning of the session. 
#To see what packages you've loaded after installation, enter `sessionInfo()` in your console. each of knitr, tidyverse, dplyr and readxl should be listed in the output.
#Have the following uncommented any time you knit this Rmd file.
library(tidyverse)

# Function that will generate the .md text that creates the toggle button to show answers for activities. To use this function, you should use it inside an code chunk set with echo = FALSE (meaning, do not show) and results = "asis", meaning print the results not in a output chunk. Check the document below for an example
startCodeDetailsBlock <- function(summaryText = "Check Your Code") {
  # Use cat to directly output the string without quotes and avoid unintended newlines
  cat(
    "{::options parse_block_html=&apos;true&apos; /}<details><summary markdown='span'>", summaryText, "</summary>"
  )
}

# Function that will generate the .md text that ends the toggle button to show answers for activities. Same usage applied as explained for function above.
endCodeDetailsBlock <- function() {
  cat("</details>{::options parse_block_html=&apos;false&apos;/}")
}
```

# Data manipulation

  - [1. Selecting specific columns](#1-selecting-specific-columns)
  - [2. Select specific rows based on a condition](#2-select-specific-rows-based-on-a-condition)
  - [3. Modify a data frame with `mutate()`](3-modify-a-data-frame-with-mutate)
  - [4. Sorting data with `arrange()`](#4-sorting-data-with-arrange)
  - [5. Summarizing variables with `summarise()`](#5-summarizing-variables-with-summarise)
  - [6. Analyzing groups with `group_by()`](#6-analyzing-groups-with-group_by)

<style type="text/css">
div.html-widget {
  overflow-x: auto;
}
&#10;table {
  display: block;
  max-width: none;
  white-space: nowrap;
}
</style>

<img src="images/tidyverse-logo.png" alt="tidyverse logo" style="float:right;width:180px;"/>

IMPROVE INTRODUCTORY TEXT

```{r echo = FALSE}
# Load data
purchaseData <- read.csv("docs/Global_Superstore_Orders_2016.csv")
```

When we work with data, it can be useful to work with smaller sections
of data.

In the remainder of activity 5, we will look at ways to select subsets
of our data to make it easier to work with.

- We will use piping to filter productData based on different
  conditions, such as:
  - Previewing only the column names that begin with `Product`
  - Previewing only the purchases from Tampa Bay
  - Previewing only the purchases that are corporate orders
  - Previewing only the purchases from Tampa that aren‚Äôt critical
    priority

Before we begin to filter, we need to look at Operators.

**Definition - ‚ÄúOperators‚Äù:** Special symbols or keywords used to
perform operations on arguments - logical operators specifically
designed for connecting or modifying boolean (true/false) logic
statements. <br>

**Operators**

- Logical operators
  - \< means ‚Äúless than‚Äù
  - \<= means ‚Äúless than or equal to‚Äù
  - \> means ‚Äúgreater than‚Äù
  - \>= means ‚Äúgreater than or equal to‚Äù
  - == means ‚Äúexactly equal to‚Äù
  - != means ‚Äúnot equal to‚Äù
- Connecting logical statements:
  - x \| y means ‚Äúx or y‚Äù
  - x & y means ‚Äúx and y‚Äù

## 1. Selecting specific columns

The commands in this section will not create new objects as we won‚Äôt be using them later on.

**Note: End each command in this section with `%>% head(5)`**

- Not using that to end commands that extract full columns of data will display a LOT.

- This will make things easier for you.
  
- If you were working with your own data, you would not need to add the `%>% head(5)`

To get a specific column, use piping and the `select()` function on  your data set.

  - The parameter of `select()` is the name of the column you want to access.

<div class="task-box" markdown="1">

‚≠ê <u>Task 2-1</u>

**View a column**

Preview the values in the Row ID column.

- Column name: `Row_ID`

```{r echo = F, results='asis'}
startCodeDetailsBlock(summaryText = "Check your code")
```

```{r}
#data set %>% select the column titled `Row ID` and view the first 5 items.
purchaseData %>%
  select(Row_ID) %>%
  head(5)
```

```{r echo = F, results='asis'}
endCodeDetailsBlock()
```

*Hint:* Begin with the name of the data set, followed by your select
function passing in the column name as the parameter.

</div>

To select all of the columns from our data set that do *not* start with
specific text, we do the inverse,

- Again using the `select()` function
- The parameter has a minus sign `-` before the string value we want to
  exclude.

<div class="task-box" markdown="1">

‚≠ê <u>Task 2-2</u>

**Get a set of columns from data frame**

Select all the columns from your purchase data that are *not* the 
‚ÄúPostal_Code‚Äù column.

```{r echo = F, results='asis'}
startCodeDetailsBlock(summaryText = "Check your code")
```

```{r}
purchaseData %>%
  select(-Postal_Code) %>%
  head(5)
```

```{r echo = F, results='asis'}
endCodeDetailsBlock()
```

</div>

‚ùó We can also select a *subset* of columns

- e.g., columns whose names begin with a common string of characters.

In our data set, multiple column names begin with ‚ÄúProduct‚Äù. We want to
see only the data of columns whose names begin with ‚ÄúProduct.‚Äù The
following explains the process.

- Use piping on your purchaseData

  - `purchaseData %>%`

- Use the `select()` function to select the columns

- Use the `starts_with()` function as the parameter for `select()`. In this
  case, you won't pipe the results of `select()` into `starts_with()`, as you
  want the select to work on the `start_with()` parameter. That is, they are
  working simulteanously, and therefore, a pipe won't work.

  - note that you‚Äôre selecting all columns that start with a specific
    name, rather than one column that is exactly equal to or not equal
    to a specific value

- The parameter for `starts_with()` is the value of the beginning of all
  columns you want to select.

<div class="task-box" markdown="1">

‚≠ê <u>Task 2-3</u>

**Get a set of columns from a data frame**

Select all the columns from our cleaned purchase data that start with
‚ÄúProduct‚Äù.

Write the one-line command to achieve this with piping and the `starts_with()`
function

```{r echo = F, results='asis'}
startCodeDetailsBlock(summaryText = "Check your code")
```

```{r}
# Selects all columns (and their values) from purchaseData whose names begin with "Product"
purchaseData %>%
  select(starts_with("Product")) %>%
  head(5) # again, remember that this is just for easier visibility, you don't need to have the head() function to select columns
```

```{r echo = F, results='asis'}
endCodeDetailsBlock()
```

</div>

## 2. Select specific rows based on a condition

We may also want to handle certain items (rows) in our data set
based on certain criteria.

- This is called ‚Äúfiltering‚Äù

- We can filter for different purposes, like processing statistical
  operations, making charts and so on.

- We can even create new data objects, which can make future analyses
  easier.

To select items (rows, *not* columns), we use the `filter()` function.

- The parameter for `filter()` is logical expression based on a column of 
  the dataset. This expression will return TRUE or FALSE for each row, and
  the function will return the rows that were TRUE.

<div class="task-box" markdown="1">

‚≠ê <u>Task 2-4</u>

**Filter conditionally**

Filter all the rows from your purchase data where `Quantity` is greater
than 10.

```{r echo = F, results='asis'}
startCodeDetailsBlock(summaryText = "Check your code")
```

```{r}
purchaseData %>%
  filter(Quantity > 10) %>%
  head(5) # again, this is just for easier viewing now, but without this, you would see ALL rows that have Quantity greater than 10
```

```{r echo = F, results='asis'}
endCodeDetailsBlock()
```

*Hint:* `>` is the ‚Äògreater than‚Äô operator.

</div>

<div class="task-box" markdown="1">

‚≠ê <u>Task 2-5</u>

**Filter conditionally**

Filter all the rows from your purchase data where `City` is ‚ÄúSydney‚Äù.

```{r echo = F, results='asis'}
startCodeDetailsBlock(summaryText = "Check your code")
```

```{r}
purchaseData %>%
  filter(City == "Sydney") %>%
  head(5) # again, this is just for easier viewing now, but without this, you would see ALL rows that have Sidney listed as City
```

```{r echo = F, results='asis'}
endCodeDetailsBlock()
```

*Hint:* `==` is used for ‚Äúequal to‚Äù

</div>

<div class="task-box" markdown="1">

‚≠ê <u>Task 2-6</u>

**Create a data frame**

Create a new data frame with all the rows from purchaseData where
`Country` is ‚ÄúUnited States‚Äù and `Discount` is greater than 0.

- Name this data frame: `discountedUSPurchases`

- Do not add ‚Äù %\>% head(5)‚Äù to the command when <u>creating</u> a new
  data frame. We were just using this to <u>view</u> subsets of the data.

```{r echo = F, results='asis'}
startCodeDetailsBlock(summaryText = "Check your code")
```

```{r}
# Create the dataframe
discountedUSPurchases <- purchaseData %>%
                          filter(Country == "United States" & Discount > 0)

# View your data frame
discountedUSPurchases %>%
  head(5)
```

```{r echo = F, results='asis'}
endCodeDetailsBlock()
```

*Hint:* `&` is used for ‚Äúand‚Äù, in
cases where you want to manage multiple cases like filtering my two
variables<br> - e.g., values of the `Country` and `Discount`
columns.

</div>

------------------------------------------------------------------------

üìç Reminder! Save your work

------------------------------------------------------------------------

## 3. Modify a data frame with `mutate()`

‚ÄúMutation‚Äù involves creating or altering columns in a data frame,

- using the `mutate()` function
  - e.g., If you have a column with a range of numbers, but you want to
    be able to quickly work with the data only over or under a specific
    value, like any orders under \$10, you can create a ‚ÄúCheap‚Äù column
    and the values would be TRUE or FALSE.
- adds new variables or modifies existing ones.

<br> <u>Here‚Äôs how we‚Äôll do it:</u>

- Assign the mutation (modification) to the existing dataframe (or new object
  if you want to create a new one rather than adding a new column to an existing one)
  - `existing_dataframe_name <-`
- Identify the existing name of the object you want to mutate
  - `existing_dataframe_name`
- Use a pipe to identify the action being performed on our existing
  object
  - `%>%`
- Identify that the action being performed on the existing object is
  the mutation
  - using the `mutate()` function
- Pass the condition in as the parameter for the `mutate` function
  - If we want to add a variable (column), begin the parameter of
    `mutate()` with `new_column_name =`
    - `=` means the values assigned to each item in that column is
      generated by the following condition
    - The new column name is and is followed by the expression to create the
      new variable
  - Say we want to add a column that has a TRUE/FALSE variable (aka
    boolean) for whether the order priority is low.
    - The expression will be `Order_Priority == "Low"`
      - `==` means ‚Äúthe left value is equal to the right value‚Äù
        - The result will be a vector with TRUE or FALSE, with TRUE for every
          row in the data is ‚ÄúLow‚Äù in the "Order_Priority" column, and FALSE
          otherwise

```{r}
purchaseData <- purchaseData %>%
      mutate(Low_Priority = (Order_Priority == "Low"))

#view first 3 rows of your data frame
purchaseData %>%
    head(3)
# Note how there is a new column at the end called "Low_Priority". It starts with
# 3 values of FALSE as the first 3 rows were not low priority (see the Order_Priority column)
```

<div class="task-box" markdown="1">

‚≠ê <u>Task 2-7</u>

**Add a column to your dataframe**

Now try it yourself. Add a new boolean (TRUE/FALSE) variable (column) to
the purchase data that identifies whether a purchase‚Äôs shipping cost is
greater than 100 dollars.

- Name the new column: `High_Shipping`
- The value will be TRUE if the `Shipping_Cost` value is over (`>`) 100.

```{r echo = F, results='asis'}
startCodeDetailsBlock(summaryText = "Check your code")
```

```{r}
purchaseData <- purchaseData %>%
  mutate(High_Shipping = (Shipping_Cost > 100))

#view your data frame
purchaseData %>%
  head(5)
```

```{r echo = F, results='asis'}
endCodeDetailsBlock()
```

*Hint:* `Shipping_Cost > 100`

</div>

The `mutate()` function also allows you to change the data type for each variable by substituting with a new variable or to create a new variable based on calculations between two variables. For example, let's imagine you wanted to know how long it takes to ship a product after it is ordered to see if the process can be streamlined or improved. To do that, you would need to:
- Transform your data variables into a date data type (a specific type of data that allows for calculating differences between dates);
- Calculate the difference in days between the two date variables (`Order_date` and `Ship_date`) and save it in a new variable.

Here's how you can do that using the `mutate()` function

```{r}
purchaseData <- purchaseData %>% # Get the purchaseData object
  mutate( # identify that you want to mutate variables
    # Different variables that are being mutated inside the mutate function
    # should be separated by comma
    Order_Date = as.Date(Order_Date), # create a variable that is the same as the Order_Date
    # variable but transformed to date type, and overwrite Order_Date with that new variable
    Ship_Date = as.Date(Ship_Date), # repeat for the Ship_Date variable
    days_to_ship = Ship_Date - Order_Date # calculate the difference in days between both dates variables
  )

# View the dataset
purchaseData %>%
  head(5)
```

## 4. Sorting data with `arrange()`

Being able to arrange data by ordering values numerically or
alphabetically is particularly handy for swiftly identifying which
measurements recorded the highest or lowest values.

The `arrange()` function enables you to order your data frame according
to the values of a specific variable.

- Parameter of `arrange()` is the column you want to use to sort your data frame

- This is particularly handy for swiftly identifying which measurements
  recorded the highest or lowest values.

When using `arrange()`, you specify the column name that you wish to
organize by.

*hint*: You can also use the `sort()` function but it only takes a
vector parameter, not a data frame.

<div class="task-box" markdown="1">

‚≠ê <u>Task 2-8</u>

**Sort data frame**

Update `purchaseData` to sort objects by price (column `Sales`).

```{r echo = F, results='asis'}
startCodeDetailsBlock(summaryText = "Check your code")
```

```{r}
purchaseData <- purchaseData %>%
                    arrange(Sales)

# View your data frame
purchaseData %>%
  head(5)
```

```{r echo = F, results='asis'}
endCodeDetailsBlock()
```

*Hint:* Do not wrap the column
name in quotations.

</div>

## 5. Summarizing variables with `summarise()`

The `summarise()` function synthesizes information into a data frame
with information like totals, averages, medians, and so on. It reduces 
the number of rows in the dataframe by summarizing information from 
multiple rows into one value (e.g., mean value)

- `summarise()` takes an unlimited number of parameters, where each
  parameter will appear as a column. <br>

<div class="task-box" markdown="1">

‚≠ê <u>Task 2-9</u>

**Preview statistics**

Preview the mean sales values and mean discount values in the discounted
US purchases data using the `summarise()` function.

- parameter 1: `columnName = mean(column)`
- another parameter: `columnName2 = mean(another column)`

```{r echo = F, results='asis'}
startCodeDetailsBlock(summaryText = "Check your code")
```

```{r}
# Only purchases made in the US with discounts (we created this object before)
discountedUSPurchases %>% 
   summarise( # call the summarise() function. It is helpful to break the parameters into different lines to see the new columns you are creating
        meanSales = mean(Sales),    #average sale price 
        meanDiscount = mean(Discount) # and average discount
              )

#To retrieve this data later, assign this command to a new variable.
```

```{r echo = F, results='asis'}
endCodeDetailsBlock()
```

*Hint:* Both spellings, `summarize` or `summarise`, will work.

</div>

## 6. Analyzing groups with `group_by()`

Let‚Äôs say we wanted to know how profitable each US city is.

That means we want to get the average profit, but grouped by US city.

As you recall, we can use summarise to get an average, but in this case,
we want to calculate the average within groups. That's where the `group_by`
function comes in handy.

- The parameter of the `group_by()` function is the name of the column you
  want to group by. No need to use quotation marks.

<div class="task-box" markdown="1">

‚≠ê <u>Task 2-10</u>

**Create a data frame**

Create a data frame of US Cities and the profit on discounted values for each.

- You will use the `discountedUSPurchases` data frame to create this
  *new* data frame.
- Name the new data frame `USCityProfits`.
- You will use `group_by()` with `City`, where each row will be a city.
- You will use `summarise()` function to get the summary statistics for
  each city.
- The statistic you will be summarizing is the total `Profit` values on
  purchases made in the US where the items have been discounted.

```{r echo = F, results='asis'}
startCodeDetailsBlock(summaryText = "Check your code")
```

```{r}
# Only purchases made in the US with discounts
USCityProfits <- discountedUSPurchases %>% 
      group_by(City) %>% # group by city purchase was made in
      summarise(totalProfit = sum(Profit)) # total profit for each city

# Now view your results
USCityProfits
```
*Note:* You might have noticed that the resulting data frame is displayed a bit differently than before. This is because in the tidyverse package, data frames take this new format called `tibbles`, that are previewed in this way you are seeing above. Using the `group_by()` and `summarise()` functions together has automatically transformed your results into a `tibble`. They are the same as data frames, but are just printed differently in the console as an ouput.
    
```{r echo = F, results='asis'}
endCodeDetailsBlock()
```

</div>

The table will be sorted by city, alphabetically

Optional activities: You can now use the functions you just learned to review this new data
frame.

‚≠ê **Sort the table by `Profit` using the `arrange()` function to order
it by the lowest profitable city to the highest profitable city.**

<br>

```{r echo = F, results='asis'}
startCodeDetailsBlock(summaryText = "Check your code")
```

```{r}
USCityProfits <- USCityProfits %>%
                        arrange(totalProfit)
```

```{r echo = F, results='asis'}
endCodeDetailsBlock()
```

<br>

‚≠ê **View the 5 least profitable cities.** <br>

```{r echo = F, results='asis'}
startCodeDetailsBlock(summaryText = "Check your code")
```

```{r}
# Least profitable are at the top of our data frame, since `arrange()` puts data in ascending order by default. 
USCityProfits %>%
    head(5)
```

```{r echo = F, results='asis'}
endCodeDetailsBlock()
```

‚≠ê **View the 5 most profitable cities.**

Use `tail()` to get the last 5 rows of a data frame.

```{r echo = F, results='asis'}
startCodeDetailsBlock(summaryText = "Check your code")
```

```{r}
# Most profitable are at the end of our data frame
USCityProfits %>%
        tail(5)
```

```{r echo = F, results='asis'}
endCodeDetailsBlock()
```

------------------------------------------------------------------------

üìç Reminder! Save your work.

------------------------------------------------------------------------

<script>  
function toggle(input) {
    var x = document.getElementById(input);
    if (x.style.display === "none") {
        x.style.display = "block";
    } else {
        x.style.display = "none";
    }
}
</script>
<style>
details {
    background-color: lightgray; 
    padding: 10px;
    margin: 5px;
    border-radius: 5px;
}
.task-box {
      border: 1.5px solid #ccc;
      padding: 10px;
      margin: 10px 0;
      border-radius: 5px;
      background-color: #f5f2f6;
  }
  &#10;</style>
<!--https://gist.github.com/rxaviers/7360908-->

[NEXT STEP: Data Visualization](data-vizualization.html){: .btn
.btn-blue }
